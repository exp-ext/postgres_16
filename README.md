# PostgreSQL —Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –±—ç–∫–∞–ø–æ–º –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –≤ Docker

**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π** —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ PostgreSQL —Å  

- –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º –±—ç–∫–∞–ø–æ–º –≤ S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –±–∞–∫–µ—Ç (VK Cloud),  
- –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä—É—á–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞,  
- –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–∞–º–ø–∞ –∏–∑ –±–∞–∫–µ—Ç–∞,  
- –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –≤ Docker Volume.

---

## üîç –°—Ç—Ä—É–∫—Ç—É—Ä–∞

‚îú‚îÄ‚îÄ backup/ # –ö–æ–Ω—Ç–µ–∫—Å—Ç Docker-–æ–±—Ä–∞–∑–∞
‚îÇ ‚îú‚îÄ‚îÄ Dockerfile # –û–ø–∏—Å–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ postgres:+awscli+cron
‚îÇ ‚îú‚îÄ‚îÄ entrypoint.sh # –ó–∞–ø—É—Å–∫ PostgreSQL + –≤—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏–π
‚îÇ ‚îú‚îÄ‚îÄ backup.sh # –õ–æ–≥–∏–∫–∞ –¥–∞–º–ø–∞ –∏ –∑–∞–ª–∏–≤–∫–∏ –≤ S3 + —á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö
‚îÇ ‚îú‚îÄ‚îÄ restore.sh # –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–∞–º–ø–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
‚îÇ ‚îú‚îÄ‚îÄ backup_db # –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è backup.sh
‚îÇ ‚îú‚îÄ‚îÄ restore_db # –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è restore.sh
‚îÇ ‚îî‚îÄ‚îÄ .dockerignore # –§–∞–π–ª—ã, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã–µ –ø—Ä–∏ docker build
‚îÇ
‚îú‚îÄ‚îÄ docker-compose.yml # –û–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤: db + pgadmin
‚îú‚îÄ‚îÄ .env.example # –ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
‚îî‚îÄ‚îÄ README.md # –≠—Ç–æ—Ç —Ñ–∞–π–ª

---

## ‚öôÔ∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Docker ‚â• 20.10  
- Docker Compose ‚â• 1.27  
- –ê–∫–∫–∞—É–Ω—Ç –≤ DockerHub (–¥–ª—è CI/CD)  
- AWS S3-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π –±–∞–∫–µ—Ç (VK Cloud Storage)  
- –§–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞  

---

## üìù –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–∞–π–ª `.env` (—Å–º. `.env.example`):

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è             | –û–ø–∏—Å–∞–Ω–∏–µ                                                      |
|------------------------|---------------------------------------------------------------|
| `POSTGRES_DB`          | –ò–º—è –ë–î –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `geocad`)                 |
| `POSTGRES_USER`        | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å PostgreSQL                                       |
| `POSTGRES_PASSWORD`    | –ü–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è PostgreSQL                                |
| `AWS_ACCESS_KEY_ID`    | –ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –∫ S3 (VK Cloud)                                  |
| `AWS_SECRET_ACCESS_KEY`| –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á S3                                             |
| `AWS_DEFAULT_REGION`   | –†–µ–≥–∏–æ–Ω S3 (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ru-msk`)                                |
| `AWS_ENDPOINT`         | Endpoint VK Cloud (–Ω–∞–ø—Ä–∏–º–µ—Ä, `https://hb.ru-msk.vkcs.cloud`)  |
| `BUCKET`               | –ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–∫–µ—Ç–∞ (–±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ `s3://`)                        |
| `PGADMIN_DEFAULT_EMAIL`    | Email –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ pgAdmin                                |
| `PGADMIN_DEFAULT_PASSWORD` | –ü–∞—Ä–æ–ª—å –¥–ª—è pgAdmin                                         |

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π**  

```bash
git clone https://github.com/exp-ext/postgres_16.git
# –∑–∞–ø–æ–ª–Ω–∏—Ç–µ .env
```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã**

```bash
docker-compose up -d
```

## üîß –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–í—Å–µ —Ä—É—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –æ—Ç –∏–º–µ–Ω–∏ —Å–µ—Ä–≤–∏—Å–∞ db (–∏–ª–∏ pg_main).

1. –†—É—á–Ω–æ–π –±—ç–∫–∞–ø

```bash
docker-compose exec db backup_db
```

–ò–ª–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:

```bash
docker-compose run --rm db backup_db
```

‚Äî —Å–æ–∑–¥–∞—Å—Ç –¥–∞–º–ø —Ç–µ–∫—É—â–µ–π –±–∞–∑—ã, –∑–∞–≥—Ä—É–∑–∏—Ç –µ–≥–æ –≤ S3 –∏ —É–¥–∞–ª–∏—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª.

2. –†—É—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–∞–º–ø–∞

```bash
docker-compose exec db restore_db
```

–ò–ª–∏:

```bash
docker-compose run --rm db restore_db
```

‚Äî —Å–∫–∞—á–∞–µ—Ç —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π –¥–∞–º–ø –∏–∑ –±–∞–∫–µ—Ç–∞, —É–¥–∞–ª–∏—Ç —Å—Ç–∞—Ä—É—é –ë–î, —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –∏–∑ –Ω–µ–≥–æ –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã.
